#### å‰è¨€

| ç±»åˆ«       | å…³é”®å­— | è¿”å›ç±»å‹    | æ­æ¡£                  |
| :--------- | :----- | :---------- | :-------------------- |
| å¤šå…ƒç´ åŒæ­¥ | sync*  | Iterable<T> | yieldã€yield*         |
| å•å…ƒç´ å¼‚æ­¥ | async  | Future<T>   | await                 |
| å¤šå…ƒç´ å¼‚æ­¥ | async* | Stream<T>   | yieldã€yield* ã€await |

#### ä¸€ã€å¤šå…ƒç´ åŒæ­¥å‡½æ•°ç”Ÿæˆå™¨

##### 1. `sync*` å’Œ `yield`

>  `sync*`æ˜¯ä¸€ä¸ªdartè¯­æ³•`å…³é”®å­—`ã€‚`å®ƒæ ‡æ³¨åœ¨å‡½æ•°{ ä¹‹å‰ï¼Œå…¶æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª Iterable<T>å¯¹è±¡` ? çš„ç ä¸º`\u{1f47f}`ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨`sync*`ç”Ÿæˆå10ä¸ªemoji`è¿­ä»£(Iterable)å¯¹è±¡`çš„æ–¹æ³• 

```dart
main() {
  getEmoji(10).forEach(print);
}

Iterable<String> getEmoji(int count) sync* {
  Runes first = Runes('\u{1f47f}');
  for (int i = 0; i < count; i++) {
    yield String.fromCharCodes(first.map((e) => e + i));
  }
}
// è¾“å‡º
ğŸ‘¿
ğŸ’€
ğŸ’
ğŸ’‚
ğŸ’ƒ
ğŸ’„
ğŸ’…
ğŸ’†
ğŸ’‡
ğŸ’ˆ
```

##### 2ã€`sync*` å’Œ `yield*`

>  `yield*`åˆæ˜¯ä½•è®¸äººä¹Ÿ? è®°ä½ä¸€ç‚¹`yield*`åé¢çš„è¡¨è¾¾å¼æ˜¯ä¸€ä¸ª`Iterable<T>å¯¹è±¡` æ¯”å¦‚ä¸‹é¢`getEmoji`æ–¹æ³•æ˜¯æ ¸å¿ƒï¼Œç°åœ¨æƒ³è¦æ‰“å°æ¯æ¬¡çš„æ—¶é—´ï¼Œä½¿ç”¨`getEmojiWithTime` `yield*`ä¹‹åçš„`getEmoji(count).map((e)...`ä¾¿æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡`Iterable<String>` 

```javascript
main() {
  getEmojiWithTime(10).forEach(print);
}

Iterable<String> getEmojiWithTime(int count) sync* {
  yield* getEmoji(count).map((e) => '$e -- ${DateTime.now().toIso8601String()}');
}

Iterable<String> getEmoji(int count) sync* {
  Runes first = Runes('\u{1f47f}');
  for (int i = 0; i < count; i++) {
    yield String.fromCharCodes(first.map((e) => e + i));
  }
}
å¤åˆ¶ä»£ç 
ğŸ‘¿ -- 2020-05-20T07:01:07.163407
ğŸ’€ -- 2020-05-20T07:01:07.169451
ğŸ’ -- 2020-05-20T07:01:07.169612
ğŸ’‚ -- 2020-05-20T07:01:07.169676
ğŸ’ƒ -- 2020-05-20T07:01:07.169712
ğŸ’„ -- 2020-05-20T07:01:07.169737
ğŸ’… -- 2020-05-20T07:01:07.169760
ğŸ’† -- 2020-05-20T07:01:07.169789
ğŸ’‡ -- 2020-05-20T07:01:07.169812
ğŸ’ˆ -- 2020-05-20T07:01:07.169832
```

------

#### äºŒã€å¼‚æ­¥å¤„ç†: `async`å’Œ`await`

>  `async`æ˜¯ä¸€ä¸ªdartè¯­æ³•`å…³é”®å­—`ã€‚`å®ƒæ ‡æ³¨åœ¨å‡½æ•°{ ä¹‹å‰ï¼Œå…¶æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª Future<T>å¯¹è±¡` å¯¹äºè€—æ—¶æ“ä½œï¼Œé€šå¸¸ç”¨`Future<T>`å¯¹è±¡å¼‚æ­¥å¤„ç†ï¼Œä¸‹é¢`fetchEmojiæ–¹æ³•`æ¨¡æ‹Ÿ2såŠ è½½è€—æ—¶ 

```javascript
main() {
  print('ç¨‹åºå¼€å¯--${DateTime.now().toIso8601String()}');
  fetchEmoji(1).then(print);
}

Future<String> fetchEmoji(int count) async{
  Runes first = Runes('\u{1f47f}');
  await Future.delayed(Duration(seconds: 2));//æ¨¡æ‹Ÿè€—æ—¶
  print('åŠ è½½ç»“æŸ--${DateTime.now().toIso8601String()}');
  return String.fromCharCodes(first.map((e) => e + count));
}
å¤åˆ¶ä»£ç 
åŠ è½½å¼€å§‹--2020-05-20T07:20:32.156074
åŠ è½½ç»“æŸ--2020-05-20T07:20:34.175806
?
```

------

#### ä¸‰ã€å¤šå…ƒç´ å¼‚æ­¥å‡½æ•°ç”Ÿæˆå™¨:

##### 1.`async*`å’Œ`yield`ã€`await`

>  `async*`æ˜¯ä¸€ä¸ªdartè¯­æ³•`å…³é”®å­—`ã€‚`å®ƒæ ‡æ³¨åœ¨å‡½æ•°{ ä¹‹å‰ï¼Œå…¶æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª Stream<T>å¯¹è±¡` ä¸‹é¢`fetchEmojis`è¢«`async*`æ ‡æ³¨ï¼Œæ‰€ä»¥è¿”å›çš„å¿…ç„¶æ˜¯`Stream`å¯¹è±¡ æ³¨æ„`è¢«async*`æ ‡æ³¨çš„å‡½æ•°ï¼Œå¯ä»¥åœ¨å…¶å†…éƒ¨ä½¿ç”¨`yieldã€yield*ã€await`å…³é”®å­— 

```javascript
main() {
  fetchEmojis(10).listen(print);
}

Stream<String> fetchEmojis(int count) async*{
  for (int i = 0; i < count; i++) {
    yield await fetchEmoji(i);
  }
}

Future<String> fetchEmoji(int count) async{
  Runes first = Runes('\u{1f47f}');
  print('åŠ è½½å¼€å§‹--${DateTime.now().toIso8601String()}');
  await Future.delayed(Duration(seconds: 2));//æ¨¡æ‹Ÿè€—æ—¶
  print('åŠ è½½ç»“æŸ--${DateTime.now().toIso8601String()}');
  return String.fromCharCodes(first.map((e) => e + count));
}
å¤åˆ¶ä»£ç 
åŠ è½½å¼€å§‹--2020-05-20T07:28:28.394205
åŠ è½½ç»“æŸ--2020-05-20T07:28:30.409498
?
åŠ è½½å¼€å§‹--2020-05-20T07:28:30.416714
åŠ è½½ç»“æŸ--2020-05-20T07:28:32.419157
?
åŠ è½½å¼€å§‹--2020-05-20T07:28:32.419388
åŠ è½½ç»“æŸ--2020-05-20T07:28:34.423053
?
åŠ è½½å¼€å§‹--2020-05-20T07:28:34.423284
åŠ è½½ç»“æŸ--2020-05-20T07:28:36.428161
?
åŠ è½½å¼€å§‹--2020-05-20T07:28:36.428393
åŠ è½½ç»“æŸ--2020-05-20T07:28:38.433409
?
åŠ è½½å¼€å§‹--2020-05-20T07:28:38.433647
åŠ è½½ç»“æŸ--2020-05-20T07:28:40.436491
?
åŠ è½½å¼€å§‹--2020-05-20T07:28:40.436734
åŠ è½½ç»“æŸ--2020-05-20T07:28:42.440696
?
åŠ è½½å¼€å§‹--2020-05-20T07:28:42.441255
åŠ è½½ç»“æŸ--2020-05-20T07:28:44.445558
?
åŠ è½½å¼€å§‹--2020-05-20T07:28:44.445801
åŠ è½½ç»“æŸ--2020-05-20T07:28:46.448190
?
åŠ è½½å¼€å§‹--2020-05-20T07:28:46.448432
åŠ è½½ç»“æŸ--2020-05-20T07:28:48.452624
?
```

------

##### 2.`async*`å’Œ`yield*`ã€`await`

>  å’Œä¸Šé¢çš„`yield*`åŒç†ï¼Œ`async*`æ–¹æ³•å†…ä½¿ç”¨`yield*`,å…¶åå¯¹è±¡å¿…é¡»æ˜¯`Stream<T>`å¯¹è±¡ å¦‚ä¸‹`getEmojiWithTime`å¯¹`fetchEmojis`æµè¿›è¡Œmapè½¬æ¢ï¼Œå‰é¢éœ€è¦åŠ `yield*` 

```javascript
main() {
  getEmojiWithTime(10).listen(print);
}

Stream<String> getEmojiWithTime(int count) async* {
  yield* fetchEmojis(count).map((e) => '$e -- ${DateTime.now().toIso8601String()}');
}

Stream<String> fetchEmojis(int count) async*{
  for (int i = 0; i < count; i++) {
    yield await fetchEmoji(i);
  }
}

Future<String> fetchEmoji(int count) async{
  Runes first = Runes('\u{1f47f}');
  await Future.delayed(Duration(seconds: 2));//æ¨¡æ‹Ÿè€—æ—¶
  return String.fromCharCodes(first.map((e) => e + count));
}
å¤åˆ¶ä»£ç 
? -- 2020-05-20T07:35:09.461624
? -- 2020-05-20T07:35:11.471223
? -- 2020-05-20T07:35:13.476712
? -- 2020-05-20T07:35:15.482848
? -- 2020-05-20T07:35:17.489429
? -- 2020-05-20T07:35:19.491214
? -- 2020-05-20T07:35:21.497086
? -- 2020-05-20T07:35:23.500867
? -- 2020-05-20T07:35:25.505379
? -- 2020-05-20T07:35:27.511723
```

------

#### å››ã€Streamçš„ä½¿ç”¨-StreamBuilder

>  Streamåœ¨ç»„ä»¶å±‚é¢æœ€å¸¸ç”¨çš„å°±æ•°`StreamBuilder`,æœ¬æ–‡åªæ˜¯ç®€å•ç”¨ä¸€ä¸‹ï¼Œä»¥åä¼šæœ‰ä¸“æ–‡ `StreamBuilder`ç»„ä»¶ä½¿ç”¨çš„æ ¸å¿ƒå°±æ˜¯ï¼Œå®ƒæ¥å—ä¸€ä¸ª`Streamå¯¹è±¡`, æ ¹æ®`builderå‡½æ•°`åœ¨æµå…ƒç´ çš„ä¸åŒçŠ¶æ€ä¸‹æ„å»ºä¸åŒçš„ç•Œé¢ã€‚ 

![](image/rfguks6y8q (1).gif)

##### 1.é¡¶éƒ¨ç»„ä»¶

```javascript
import 'dart:async';
import 'package:flutter/material.dart';

void main() => runApp(MyApp());

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
        title: 'Flutter Demo',
        theme: ThemeData(
          primarySwatch: Colors.blue,
        ),
        home: Scaffold(
          appBar: AppBar(),
          body: HomePage(),
        ));
  }
}
```

------

##### 2.StreamBuilderç»„ä»¶çš„ä½¿ç”¨

```dart
class HomePage extends StatefulWidget {
  
  @override
  _HomePageState createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
   Stream<String> _stream;
  @override
  void initState() {
    super.initState();
    _stream= fetchEmojis(10);
  }
  
  @override
  Widget build(BuildContext context) {
    return Center(
      child: StreamBuilder<String>(
        builder: _buildChildByStream,
        stream: _stream,
      ),
    );
  }

  Widget _buildChildByStream(
      BuildContext context, AsyncSnapshot<String> snapshot) {
    switch(snapshot.connectionState){
      case ConnectionState.none:
        break;
      case ConnectionState.waiting:
        return CircularProgressIndicator();
        break;
      case ConnectionState.active:
        return Text(snapshot.requireData,style: TextStyle(fontSize: 60));
        break;
      case ConnectionState.done:
        return Text('Stream Over--${snapshot.requireData}',style: TextStyle(fontSize: 30),);
        break;
    }
    return Container();
  }

   Stream<String> fetchEmojis(int count) async* {
     for (int i = 0; i < count; i++) {
       yield await fetchEmoji(i);
     }
   }

   Future<String> fetchEmoji(int count) async {
     Runes first = Runes('\u{1f47f}');
     await Future.delayed(Duration(seconds: 1)); //æ¨¡æ‹Ÿè€—æ—¶
     return String.fromCharCodes(first.map((e) => e + count));
   }
}
```

------

##### é¢˜å¤–è¯:

>  å¦‚æœä½ ä½¿ç”¨è¿‡`flutter_bloc`,ä¼šç”¨åˆ°`async*`,ç°åœ¨å†æ¥çœ‹ï¼Œæ˜¯ä¸æ˜¯æ›´æ¸…æ¥šäº†ä¸€ç‚¹ã€‚ 

```dart
class CounterBloc extends Bloc<CounterEvent, int> {
  @override
  int get initialState => 0;

  @override
  Stream<int> mapEventToState(CounterEvent event) async* {
    switch (event) {
      case CounterEvent.decrement:
        yield state - 1;
        break;
      case CounterEvent.increment:
        yield state + 1;
        break;
    }
  }
}
```



### ç”Ÿæˆå™¨
#### åŒæ­¥ç”Ÿæˆå™¨ sync*

```dart
void main() {

  print('main start');

  Iterator iterator = syncGenerator(5).iterator;
  while (iterator.moveNext()) {
    print(iterator.current);
  }

  print('main end');
}

// åŒæ­¥ç”Ÿæˆå™¨
Iterable<int> syncGenerator(int n) sync*{
  print('start');
  int i = n;
  while(i > 0) {
    print('generator: $i');
    yield i-- ;	// yield äº§å‡ºç»“æœ
  }
  print('end');
}
```

#### å¼‚æ­¥ç”Ÿæˆå™¨ async*

```dart
void main() {

  print('main start');

  StreamSubscription subscription = asyncGenerator(5).listen(null);
  subscription.onData((handleData) {
    print(handleData);
    if (handleData > 1) {	// å¼‚æ­¥ç”Ÿæˆå™¨å¯ä»¥è¢«ä¸­æ–­
      subscription.pause();
    }
  });
//  StreamSubscription subscription = asyncGenerator(5).listen((value) {
//    print('sub $value');
//  });

  print('main end');
}

// å¼‚æ­¥ç”Ÿæˆå™¨
Stream<int> asyncGenerator(int n) async*{
  print('start');
  int i = 0;
  while(i < n){
    print('generator: $i');
    yield i++;	// yield äº§å‡ºç»“æœ
  }
  print('end');
}
```


#### yield ä¸ yield*
yield ç›´æ¥è¾“å‡ºç»“æœ
yield* è¾“å‡ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ, ä¹Ÿå°±æ˜¯è¯´å®é™…å°†ä¼šæ‰§è¡Œyield* æ‰€è¡¨ç¤ºçš„å‡½æ•°
é€’å½’ç”Ÿæˆå™¨

```dart
void main() {

  print('main start');
  // é€’å½’ç”Ÿæˆå™¨
  Iterator iterator = getSyncRecursiveGenerator(5).iterator;
  while (iterator.moveNext()){
    print(iterator.current);
  }

  print('main end');
}

// é€’å½’ç”Ÿæˆå™¨
Iterable<int> getSyncRecursiveGenerator(int n) sync* {
  if (n > 0) {
    yield n;	// yield äº§å‡ºç»“æœ
    yield* getSyncRecursiveGenerator(n - 1);	// yield* è°ƒç”¨å‡½æ•°
  }
}
```


