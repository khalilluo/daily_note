## 配置文件
---
#### 全局配置 
可以不用配置
``` shell
global_defs {
    # 通知收件人地址
    notification_email {
        email
        email
    }
    # 通知发送邮件地址
    notification_email_from email
    
    # smtp服务器地址
    smtp_server host
    
    # smtp服务器连接超时时间
    smtp_connect_timeout num
    
    # 指定LVS导向器的名字
    lvs_id string
    
    #运行keepalived机器的一个标识，默认local host name
    router_id LVS_DEVEL 
    
	# 多播地址，一般使用默认即可
    vrrp_mcast_group4 224.0.0.18 
}
```


#### VRRP实例
``` shell
vrrp_instance VI_1 {
    state BACKUP #指定那个为master，那个为backup，如果设置了nopreempt这个值不起作用，主备靠priority决定
    interface eth0 #设置实例绑定的网卡
    mcast_src_ip #发送多播包的地址，如果不设置默认使用绑定网卡的primary ip
    virtual_router_id 50 #VPID路由器标识， 集群组内必须相同
    priority 99 #优先级，高优先级竞选为master
    advert_int 1 #检查间隔，默认1秒
    nopreempt #设置为不抢占 注：这个配置只能设置在backup主机上
    preempt_delay #抢占延时，默认5分钟
    authentication { #设置认证
        auth_type PASS #认证方式
        auth_pass 111111 #认证密码
    }
    virtual_ipaddress { #设置vip
        192.168.202.200
    }
}
```

https://www.jianshu.com/p/a910e91d43a3
https://keepalived-doc.readthedocs.io/zh_CN/latest/Keepalived%E9%85%8D%E7%BD%AE%E7%AE%80%E4%BB%8B.html
https://www.lmlphp.com/user/16538/article/item/579674/

#### 实际生成环境已使用配置
```
vrrp_instance  VI_1 {
    state  ${KA_STATE}
    interface  ${KA_INTERFACE}
    virtual_router_id  ${KA_ROUTER_ID}
    priority  ${KA_PRIORITY}
    advert_int  1
    nopreempt 
    authentication {
        auth_type  PASS
        auth_pass  ${KA_PASS}
    }
    virtual_ipaddress {
        ${KA_VIRTUAL_IP}
    }
}

```

## 不允许组播的情况
---
如果两节点的上联交换机禁用了组播，则只能采用vrrp单播通告的方式
```shell
# MASTER
vim /etc/keepalived/keepalived.conf
   priority 100
    unicast_src_ip  10.11.4.186       ##source ip
    unicast_peer {
            10.11.4.187               ##dest ip
    }

# SLAVE
vim /etc/keepalived/keepalived.conf
    priority 90
    unicast_src_ip  10.11.4.187       ##source ip
    unicast_peer {
            10.11.4.186               ##dest ip
    }
 
```

## 其他
---
##### 防火墙
```shell
firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface eth0 --destination 224.0.0.18 --protocol vrrp -j ACCEPT

firewall-cmd --direct --permanent --add-rule ipv4 filter OUTPUT 0 --out-interface eth0 --destination 224.0.0.18 --protocol vrrp -j ACCEPT

firewall-cmd --reload
```

##### 配置iptables
```shell
vim /etc/sysconfig/iptables
-A INPUT -p vrrp -j ACCEPT
# 或者：-A INPUT -m pkttype --pkt-type multicast -j ACCEPT

service iptables restart
```
