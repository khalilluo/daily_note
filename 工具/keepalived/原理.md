### 工作机制

Keepalived通过VRRP协议来竞争实现虚拟路由的功能，所有的协议报文都是通过IP多播(multicast)包发送（多播地址224.0.0.18）每个发送的多播数据包都是从多播地址发送；虚拟路由器由VRID（范围0-255）和一组IP地址组成，对外表现为一个周知的MAC地址：00-00-5E-00-01-{VRID}.所以在一个虚拟路由器中，不管谁是MASTER，对外都是相同的MAC和IP（称之为VIP）。客户端主机并不需要因为MASTER的改变而修改自己的路由配置，对他们来说，这一切都是透明的。在一个虚拟路由器中，只有作为MASTER的VRRP路由器会一直发送VRRP多播包，这里说的MASTER发送多播包就是指的是上面所说的由VRRP协议224.0.0.18地址所发出的多播包，发多播包是为了告诉Backup节点自己还活着，BACKUP就不会抢占MASTER，除非它的优先级（priority更高）。 
VRRP,全称 Virtual Router Redundancy Protocol,中文名为虚拟路由冗余协议，VRRP的出现是为了解决静态路由的单点故障。 VRRP是通过竞选机制来确定主备的，主的优先级高于备，因此，工作时主会优先获得所有的资源，备节点处于等待状态，当主挂了的时候，备节点就会接管主节点的资源，然后顶替主节点对外提供服务。　　在 Keepalived服务对之间，只有作为主的服务器会一直发送 VRRP广播包,告诉备它还活着，此时备不会枪占主，当主不可用时，即备监听不到主发送的广播包时，就会启动相关服务接管资源，保证业务的连续性.接管速度最快可以小于1秒。

### 双主模式

当Master出现问题后，Backup会竞选为新的Master，那么之前的Master如果故障恢复后，是继续成为Master还是变成Backup呢？默认情况下，如果没设置不抢占，那么之前的Master起来后还是会继续抢占成为Master，也就是说，整个过程需要发生两次切换；
Keepalived里面提供了 nopreempt 这个配置只能用在状态为Backup的机器上，但是我们明明希望的是Master不进行抢占，那没办法，Master的状态也得设置为Backup，也就是说两台负载均衡器都要将state状态设置为Backup。初始根据优先级来确定主用

### 避免脑裂
- 设置仲裁机制。例如设置参考IP（如网关IP），当心跳线完全断开时，2个节点都各自ping一下参考IP，不通则表明断点就出在本端
- 增加专线用于VRRP协议多播能正确发送